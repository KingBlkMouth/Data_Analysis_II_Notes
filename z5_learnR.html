<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data_Analysis_II_Notes - LearnR 5</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Data_Analysis_II_Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="./1_Types_of_Categoricals.html" rel="" target="">
 <span class="dropdown-text">1 Types of Categoricals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./2_Props_Risks_Odds.html" rel="" target="">
 <span class="dropdown-text">2 Props, Risk &amp; Odds</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./3_Logistic_Regression_I.html" rel="" target="">
 <span class="dropdown-text">3 Log Reg I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./4_Logistic_Regression_II.html" rel="" target="">
 <span class="dropdown-text">4 Log-Reg II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./5_Log_linear_Regression.html" rel="" target="">
 <span class="dropdown-text">5 Log-lin-Reg</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./6_Dispersion_Zero_Inflation.html" rel="" target="">
 <span class="dropdown-text">6 Disp &amp; 0 Inflation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./7_Random_Effects.html" rel="" target="">
 <span class="dropdown-text">7 Random_Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./8_Evaluating_Models.html" rel="" target="">
 <span class="dropdown-text">8 Model Eval</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./9_Imp_Pred_Validate.html" rel="" target="">
 <span class="dropdown-text">9 Imp, Pred, Validate</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10_Final_Project.html" rel="" target="">
 <span class="dropdown-text">10 Final Project</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="./z0_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 0</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z1_learnR.html" rel="" target="">
 <span class="dropdown-text">1 Types of Categoricals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z2_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z3_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z4_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z5_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z6_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z7_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 7</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./z8_learnR.html" rel="" target="">
 <span class="dropdown-text">LearnR 8</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hw" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">HW</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hw">    
        <li class="dropdown-header">aHW_0.qmd</li>
        <li>
    <a class="dropdown-item" href="./aHW_1.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_2.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_3.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_4.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_5.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_6.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_7.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 7</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./aHW_8.html" rel="" target="">
 <span class="dropdown-text">ST-518 HW 8</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#count-responses" id="toc-count-responses" class="nav-link active" data-scroll-target="#count-responses">Count responses</a></li>
  <li><a href="#salamander-data" id="toc-salamander-data" class="nav-link" data-scroll-target="#salamander-data">Salamander Data</a>
  <ul class="collapse">
  <li><a href="#some-data-exploration" id="toc-some-data-exploration" class="nav-link" data-scroll-target="#some-data-exploration">Some data exploration</a></li>
  </ul></li>
  <li><a href="#the-log-linear-model" id="toc-the-log-linear-model" class="nav-link" data-scroll-target="#the-log-linear-model">The Log Linear Model</a>
  <ul class="collapse">
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model Fitting</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model Evaluation</a></li>
  <li><a href="#drop-in-deviance-test" id="toc-drop-in-deviance-test" class="nav-link" data-scroll-target="#drop-in-deviance-test">Drop-in-deviance test</a></li>
  <li><a href="#looking-at-residuals" id="toc-looking-at-residuals" class="nav-link" data-scroll-target="#looking-at-residuals">Looking at Residuals</a></li>
  </ul></li>
  <li><a href="#log-linear-models-for-general-contingency-tables" id="toc-log-linear-models-for-general-contingency-tables" class="nav-link" data-scroll-target="#log-linear-models-for-general-contingency-tables">Log Linear Models for General Contingency Tables</a></li>
  <li><a href="#lab-5-assignment" id="toc-lab-5-assignment" class="nav-link" data-scroll-target="#lab-5-assignment">Lab 5 Assignment</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">LearnR 5</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="count-responses" class="level1">
<h1>Count responses</h1>
<p>Please load these libraries that you’ll need for this lab:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'arm' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MASS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lme4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
arm (Version 1.14-4, built: 2024-4-1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Working directory is C:/Users/cmeck/Desktop/D_Anal/Anal_II/Anal_II_Notes/Data_Analysis_II_Notes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Sleuth3)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::expand() masks Matrix::expand()
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
✖ tidyr::pack()   masks Matrix::pack()
✖ dplyr::select() masks MASS::select()
✖ tidyr::unpack() masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vcdExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'vcdExtra' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: vcd</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'vcd' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: grid
Loading required package: gnm</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'gnm' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'vcdExtra'

The following object is masked from 'package:dplyr':

    summarise</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'magrittr'

The following object is masked from 'package:purrr':

    set_names

The following object is masked from 'package:tidyr':

    extract</code></pre>
</div>
</div>
<p>In this lab, we’ll go over log linear regression in the case of count data in a little more detail than you saw in the narrated lectures. We’ll cover the deviance goodness of fit test (which, remember, is an informal test here) and the drop in deviance test in R; and we’ll discuss residuals and model evaluation. You’ll see more about over dispersion in the case of Poisson counts, and we’ll cover the negative binomial model for over dispersion. We’ll conclude with another example of log linear regression for general contingency tables.</p>
</section>
<section id="salamander-data" class="level1">
<h1>Salamander Data</h1>
<p>The data that we’ll use for this lab concern salamander habitat:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ?case2202</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>salamanders <span class="ot">&lt;-</span> case2202</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(salamanders)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Site</th>
<th style="text-align: right;">Salamanders</th>
<th style="text-align: right;">PctCover</th>
<th style="text-align: right;">ForestAge</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">316</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">86</td>
<td style="text-align: right;">88</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">548</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">88</td>
<td style="text-align: right;">64</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">89</td>
<td style="text-align: right;">43</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">83</td>
<td style="text-align: right;">368</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>As you can see (and read about in the help file) the <code>salamanders</code> data contain counts of salamanders at 47 sites in national forest and parkland; the available explanatory information is <code>PctCover</code>, a percentage of canopy cover at the site and <code>ForestAge</code>, the age of the forest at the site.</p>
<section id="some-data-exploration" class="level2">
<h2 class="anchored" data-anchor-id="some-data-exploration">Some data exploration</h2>
<p>We’ll start with some exploration of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(<span class="at">x =</span> PctCover, <span class="at">y =</span> Salamanders)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Salamanders vs Percent Cover"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This first figure seems to indicate that there are two distinct types of sites—those with <code>PctCover</code> below about 53% and those with <code>PctCover</code> greater than 75%. It also seems clear that only sites with <code>PctCover</code> greater than 75% have <code>Salamander</code> counts higher than 2.</p>
<p>Here’s another plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(<span class="at">x =</span> ForestAge, <span class="at">y =</span> Salamanders)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Salamanders vs Forest Age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There doesn’t appear to be anything remarkable about this plot, though it’s important to notice the range of the x-axis scale – it’s fairly large. This suggests that we might observe something more informative if we look at <code>ForestAge</code> on the log scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">y =</span> Salamanders)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Salamanders vs log(Forest Age)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that we used <code>x = log(ForestAge + 1/2)</code> in the <code>ggplot()</code> function call because some of the <code>ForestAge</code> values are zero, and <code>log(0)</code> is undefined.</p>
<p>This plot seems to indicate a clearer relationship between <code>ForestAge</code> and <code>Salamanders</code> – as <code>ForestAge</code> increases on the log scale, the salamander counts tend to increase and they get more variable. Let’s also look at the relationship between the two explanatory variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">y =</span> PctCover)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Percent Cover vs log(Forest Age"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This plot tells and interesting story – almost all of the older sites are those with <code>PctCover</code> greater than 75%. For the younger sites, there is a increasing (perhaps curvilinear) relationship with <code>PctCover</code>.</p>
<p>Remember that multicollinearity is a problem when two or more explanatory variables are highly correlated. Let’s check the correlation between log-transformed <code>PctCover</code> and the <code>ForestAge</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>salamanders <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="at">Site =</span> Site, <span class="at">Salamanders =</span> Salamanders, <span class="at">ForestAge =</span> ForestAge, <span class="at">logPctCover =</span> <span class="fu">log</span>(PctCover <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(salamanders<span class="sc">$</span>ForestAge,salamanders<span class="sc">$</span>logPctCover)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5352604</code></pre>
</div>
</div>
<p>The correlation is not actually so high that we should be concerned about it. Remember, too, that correlation tells us about the <em>linear</em> association between two variables. In terms of a linear association, these two variables are moderately correlated – even though from our last plot we see that there is a strong relationship between them.</p>
<p>Because of the distinctive cut-point in the <code>PctForest</code> variable, we’ll create a new variable, called <code>CovGroup</code>, that just takes the value 0 if <code>PctCover &lt; 75)</code> and 1 otherwise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>CovGroup <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(salamanders<span class="sc">$</span>PctCover <span class="sc">&lt;</span> <span class="dv">75</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, as a last bit of exploration, let’s just take a look at the histogram of <code>Salamander</code> counts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(salamanders,<span class="fu">aes</span>(Salamanders)) <span class="sc">+</span> <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can see that there are a lot of zeroes in among the <code>Salamander</code> counts. One method for analyzing Poisson count data is to take the log of the counts, and then perform a multiple linear regression. We don’t recommend that here, since there are so many zeroes – you’d have to first add a small amount to the zero counts, then take logs, and that means that interpretations will be difficult.</p>
<p>Instead, we’ll turn to fitting the log linear model (another special case of a generalized linear model).</p>
</section>
</section>
<section id="the-log-linear-model" class="level1">
<h1>The Log Linear Model</h1>
<p>Remember that for independent Poisson counts, <span class="math inline">\(Y_1,\ldots,Y_n\)</span>, each with rate parameter <span class="math inline">\(\lambda_i\)</span> for <span class="math inline">\(i = 1,\ldots,n\)</span>, we have</p>
<blockquote class="blockquote">
<p><span class="math inline">\(log(\lambda_i) = \beta_0 + \beta_1X_{1i} + \cdots + \beta_kX_{ki}\)</span></p>
</blockquote>
<p>for explanatory variables, <span class="math inline">\(X_1,\ldots,X_k\)</span>. Let’s go ahead and fit some models to the <code>salamander</code> data.</p>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model Fitting</h2>
<p>In this part of the lab, we’ll fit several different models, and make some comparisons among them. This is a little bit of data snooping, and we will likely end up with biased estimates in the model we do select (recall the simulation you saw back in Data Analytics I). So, please, consider this to be the academic exercise it’s intended to be!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model with PctCover only</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>pois_mod1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover, <span class="at">family =</span> poisson)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># model the log(Forest Age + 1/2) only</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>pois_mod2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">family =</span> poisson)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># model with both explanatory variables</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>pois_mod3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover <span class="sc">+</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">family =</span> poisson)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># model with both explanatory variables, plus their interaction</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>pois_mod4 <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover <span class="sc">*</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">family =</span> poisson)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># comparison of the models</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">LRstats</span>(pois_mod1, pois_mod2, pois_mod3, pois_mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">LR Chisq</th>
<th style="text-align: right;">Df</th>
<th style="text-align: right;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">pois_mod1</td>
<td style="text-align: right;">210.3639</td>
<td style="text-align: right;">214.0642</td>
<td style="text-align: right;">121.3050</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">pois_mod2</td>
<td style="text-align: right;">243.1239</td>
<td style="text-align: right;">246.8242</td>
<td style="text-align: right;">154.0650</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pois_mod3</td>
<td style="text-align: right;">212.0690</td>
<td style="text-align: right;">217.6195</td>
<td style="text-align: right;">121.0101</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">pois_mod4</td>
<td style="text-align: right;">213.7578</td>
<td style="text-align: right;">221.1584</td>
<td style="text-align: right;">120.6989</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>In terms of the AIC comparisons, there’s not much difference between models 1, 2 and 4; and the same is true if we use the BIC comparisons. This is somewhat surprising – from the exploratory plots above, you might have suspected that both <code>PctCover</code> and <code>ForestAge</code>, and maybe even their interaction might be important. Let’s take a look at the summary information for <code>pois_mod4</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pois_mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Salamanders ~ PctCover * log(ForestAge + 1/2), 
    family = poisson, data = salamanders)

Coefficients:
                               Estimate Std. Error z value Pr(&gt;|z|)   
(Intercept)                   -0.969454   0.820929  -1.181  0.23763   
PctCover                       0.029067   0.011184   2.599  0.00935 **
log(ForestAge + 1/2)          -0.213107   0.293009  -0.727  0.46704   
PctCover:log(ForestAge + 1/2)  0.001957   0.003423   0.572  0.56741   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 190.22  on 46  degrees of freedom
Residual deviance: 120.70  on 43  degrees of freedom
AIC: 213.76

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>It looks like there pretty clear evidence of over dispersion, the residual deviance divided by the residual degrees of freedom is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fl">120.7</span><span class="sc">/</span><span class="dv">43</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.806977</code></pre>
</div>
</div>
<p>That’s pretty big. Before we talk a lot more about model fitting and model comparison in terms of what explanatory information to include, we should address the over dispersion. Remember that we can do this using the <code>family = quasipoisson</code> argument to the <code>glm()</code> function, or we can do this using the <code>glm.nb</code> function. We’ll leave it to you to try the quasi-poisson approach, and we’ll go over the negative binomial approach here. We’ll simply fit the same four models as above, but using the negative binomial likelihood rather than the Poisson likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model with PctCover only</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>nb_mod1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># model the log(Forest Age + 1/2) only</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>nb_mod2 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># model with both explanatory variables</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>nb_mod3 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover <span class="sc">+</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># model with both explanatory variables, plus their interaction</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>nb_mod4 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> PctCover <span class="sc">*</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co"># comparison of the models</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="fu">LRstats</span>(nb_mod1, nb_mod2, nb_mod3, nb_mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">LR Chisq</th>
<th style="text-align: right;">Df</th>
<th style="text-align: right;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">nb_mod1</td>
<td style="text-align: right;">176.9625</td>
<td style="text-align: right;">182.5130</td>
<td style="text-align: right;">47.60608</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.3670830</td>
</tr>
<tr class="even">
<td style="text-align: left;">nb_mod2</td>
<td style="text-align: right;">188.2859</td>
<td style="text-align: right;">193.8363</td>
<td style="text-align: right;">47.99615</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.3523296</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nb_mod3</td>
<td style="text-align: right;">178.8296</td>
<td style="text-align: right;">186.2302</td>
<td style="text-align: right;">47.56748</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0.3295507</td>
</tr>
<tr class="even">
<td style="text-align: left;">nb_mod4</td>
<td style="text-align: right;">180.5434</td>
<td style="text-align: right;">189.7941</td>
<td style="text-align: right;">47.48537</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0.2948841</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Again, there’s no clear winner here in terms of either AIC or BIC, so we’ll go with Occam’s Razor and look at results for the simplest model, <code>nb_mod1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nb_mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Salamanders ~ PctCover, data = salamanders, 
    init.theta = 1.26199236, link = log)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.416365   0.527696  -2.684  0.00727 ** 
PctCover     0.031513   0.006655   4.735 2.19e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.262) family taken to be 1)

    Null deviance: 75.691  on 46  degrees of freedom
Residual deviance: 47.606  on 45  degrees of freedom
AIC: 176.96

Number of Fisher Scoring iterations: 1

              Theta:  1.262 
          Std. Err.:  0.478 

 2 x log-likelihood:  -170.963 </code></pre>
</div>
</div>
<p>Remember that we still didn’t use the <code>CovGroup</code> indicator variable that we created above. Let’s fit a couple more models using that variable, and see where we are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model with CovGroup only </span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>nb_mod5 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> CovGroup)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># model with CovGroup*log(ForestAge + 1/2)</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>nb_mod6 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(<span class="at">data =</span> salamanders, Salamanders <span class="sc">~</span> CovGroup <span class="sc">*</span> <span class="fu">log</span>(ForestAge <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># compare with the other models</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">LRstats</span>(nb_mod1,nb_mod2,nb_mod3,nb_mod4,nb_mod5,nb_mod6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">LR Chisq</th>
<th style="text-align: right;">Df</th>
<th style="text-align: right;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">nb_mod1</td>
<td style="text-align: right;">176.9625</td>
<td style="text-align: right;">182.5130</td>
<td style="text-align: right;">47.60608</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.3670830</td>
</tr>
<tr class="even">
<td style="text-align: left;">nb_mod2</td>
<td style="text-align: right;">188.2859</td>
<td style="text-align: right;">193.8363</td>
<td style="text-align: right;">47.99615</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.3523296</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nb_mod3</td>
<td style="text-align: right;">178.8296</td>
<td style="text-align: right;">186.2302</td>
<td style="text-align: right;">47.56748</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0.3295507</td>
</tr>
<tr class="even">
<td style="text-align: left;">nb_mod4</td>
<td style="text-align: right;">180.5434</td>
<td style="text-align: right;">189.7941</td>
<td style="text-align: right;">47.48537</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0.2948841</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nb_mod5</td>
<td style="text-align: right;">176.7513</td>
<td style="text-align: right;">182.3018</td>
<td style="text-align: right;">47.17214</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.3838253</td>
</tr>
<tr class="even">
<td style="text-align: left;">nb_mod6</td>
<td style="text-align: right;">180.7331</td>
<td style="text-align: right;">189.9838</td>
<td style="text-align: right;">47.16892</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0.3060094</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Now it seems like there’s really not much difference among any of these models (except that many <code>nb_mod2</code> is a clear-ish loser) in terms of AIC or BIC. We’ll continue with <code>nb_mod1</code> at this point. Let’s take a look at the model and it’s fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nb_mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = Salamanders ~ PctCover, data = salamanders, 
    init.theta = 1.26199236, link = log)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.416365   0.527696  -2.684  0.00727 ** 
PctCover     0.031513   0.006655   4.735 2.19e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.262) family taken to be 1)

    Null deviance: 75.691  on 46  degrees of freedom
Residual deviance: 47.606  on 45  degrees of freedom
AIC: 176.96

Number of Fisher Scoring iterations: 1

              Theta:  1.262 
          Std. Err.:  0.478 

 2 x log-likelihood:  -170.963 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>resid <span class="ot">&lt;-</span> <span class="fu">residuals</span>(nb_mod1)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">&lt;-</span> <span class="fu">predict.glm</span>(nb_mod1,<span class="at">scale=</span><span class="st">"data"</span>,<span class="at">se.fit=</span><span class="cn">TRUE</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>fits <span class="ot">&lt;-</span> <span class="fu">exp</span>(fits<span class="sc">$</span>fit)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>low <span class="ot">&lt;-</span> <span class="fu">exp</span>(fits<span class="sc">$</span>fit<span class="fl">-1.96</span><span class="sc">*</span>fits<span class="sc">$</span>se.fit)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>upp <span class="ot">&lt;-</span> <span class="fu">exp</span>(fits<span class="sc">$</span>fit<span class="fl">+1.96</span><span class="sc">*</span>fits<span class="sc">$</span>se.fit)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(salamanders,<span class="fu">aes</span>(PctCover,Salamanders)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span>      </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> PctCover, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> fits)) <span class="sc">+</span> </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x =</span> PctCover, </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymin =</span> low, </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> upp),</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The model fit is not bad – remember that the solid line in the figure above is the model estimate of the Poisson rate parameter at each value of <code>PctCover</code>, and the shaded bands are 95% pointwise confidence intervals. The model output gives strong evidence of a positive association between <code>PctCover</code> and the number of salamanders at a site.</p>
<p>Notice also that the residual deviance divided by its degrees of freedom for <code>nb_mod1</code> is very close to 1. The negative binomial model also gives an estimate of the “Theta” parameter. In the negative binomial model, if the expected count is <span class="math inline">\(E(Y)\)</span>, the variance of the count is <span class="math inline">\(Var(Y) = E(Y) + [E(Y)^2]/\theta\)</span>.</p>
<p>Since the negative binomial model uses the log-link as does the Poisson model, the interpretation of the coefficient on <code>PctCover</code> is the same as in the Poisson model – an increase of 1% in forest cover is associated with an <span class="math inline">\(exp(0.0315) = 1.03\)</span>-fold increase in the expected number of salamanders. In other words, a 1% increase in forest cover is associated with a 3% increase in expected number of salamanders at a site.</p>
</section>
<section id="model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h2>
<p>Recall that the deviance goodness of fit test compares a fitted model to a saturated model, or one in which there are as many parameters as there are data points. In these goodness of fit comparisons, the null hypothesis corresponds to the fitted model (which is a reduced model relative to the saturated model), and the alternative hypothesis corresponds to the saturated model. In the case of Poisson counts, the goodness of fit should only be used as a guideline, not as a firm decision making tool.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">LRstats</span>(nb_mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">LR Chisq</th>
<th style="text-align: right;">Df</th>
<th style="text-align: right;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">nb_mod1</td>
<td style="text-align: right;">176.9625</td>
<td style="text-align: right;">182.513</td>
<td style="text-align: right;">47.60608</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0.367083</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This large p-value may be an indication of an adequate model, but there are many small counts in the <code>salamanders</code> data, so we should not rely heavily on this result.</p>
</section>
<section id="drop-in-deviance-test" class="level2">
<h2 class="anchored" data-anchor-id="drop-in-deviance-test">Drop-in-deviance test</h2>
<p>Just a reminder that the drop in deviance test is different from the deviance goodness of fit test. Whereas the deviance goodness of fit test provides a comparison between a single fitted model and a saturated model, a drop in deviance test provides a way to compare two fitted models when one of those models is nested within the other one. Put another way, the drop in deviance test is a comparison between a reduced model (null hypothesis) and a full model (alternative hypothesis) – and we use it in cases where the reduced model is reduced from (or nested in) the full model.</p>
<p>Using the models we have already fit, let’s use the <code>anova()</code> function to perform a drop in deviance test comparing the model that only contains <code>PctCover</code> to the one that contains <code>PctCover</code>, <code>ForestAge</code> and their interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(nb_mod1,nb_mod4,<span class="at">test=</span><span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 32%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 16%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">theta</th>
<th style="text-align: right;">Resid. df</th>
<th style="text-align: right;">2 x log-lik.</th>
<th style="text-align: left;">Test</th>
<th style="text-align: right;">df</th>
<th style="text-align: right;">LR stat.</th>
<th style="text-align: right;">Pr(Chi)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PctCover</td>
<td style="text-align: right;">1.261992</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">-170.9625</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">PctCover * log(ForestAge + 1/2)</td>
<td style="text-align: right;">1.279151</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">-170.5434</td>
<td style="text-align: left;">1 vs 2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.419181</td>
<td style="text-align: right;">0.8109163</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The p-value of the drop in deviance test is rather large, giving us strong evidence that the simpler model is sufficient in this case, as compared to the more complicated model.</p>
</section>
<section id="looking-at-residuals" class="level2">
<h2 class="anchored" data-anchor-id="looking-at-residuals">Looking at Residuals</h2>
<p>As in the case of binomial logistic regression, it can be helpful to look at the deviance and/or Pearson residuals from our negative binomial (or Poisson) regression mode to (a) evaluate the model fit and (b) check for outliers. Provided that the counts are fairly large, both the deviance and Pearson residuals should look like draws from a standard Normal distribution, so too many residuals outside of the [-2,2] interval may be cause for concern. Here, we’ll look at plots of both the deviance and Pearson residuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>residuals_deviance <span class="ot">&lt;-</span> <span class="fu">residuals</span>(nb_mod1)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>salamanders<span class="sc">$</span>residuals_pearson <span class="ot">&lt;-</span> <span class="fu">residuals</span>(nb_mod1, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(PctCover,residuals_deviance)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(PctCover,residuals_pearson)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> salamanders, <span class="fu">aes</span>(residuals_deviance,residuals_pearson)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="z5_learnR_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>First, you should notice that there are some distinctive patterns in both the deviance and Pearson residual plots. These kinds of patterns are quite common when we are dealing with count data, and they are result of the discreteness of those counts. In these residual plots, we are more concerned with detecting potential outliers, and there do not appear to be any here.</p>
<p>Next, the plot of the two types of residuals against each other shows the strong relationship between them – in this case it’s not a linear relationship as it was in the case of binomial logistic regression – but it’s a strong relationship nonetheless.</p>
</section>
</section>
<section id="log-linear-models-for-general-contingency-tables" class="level1">
<h1>Log Linear Models for General Contingency Tables</h1>
<p>We’ll now turn to an example of using a log linear model for data in general contingency tables. The following table relates education level, religious views, and approval of homosexual marriage for 133 Americans age 18-25 (see example 8.4.2 in Agresti (2013)). In this table “agree” indicates that the respondent agrees that homosexual marriage should be allowed in the US.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>marriage <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">opinion =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"Agree"</span>, <span class="st">"Neutral"</span>, <span class="st">"Disagree"</span>), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Agree"</span>, <span class="st">"Neutral"</span>, <span class="st">"Disagree"</span>)),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">relig =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"Fundamentalist"</span>, <span class="st">"Moderate"</span>, <span class="st">"Liberal"</span>), <span class="fu">c</span>(<span class="st">"Liberal"</span>, <span class="st">"Moderate"</span>, <span class="st">"Fundamentalist"</span>)),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">educ =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"High school or less"</span>, <span class="st">"At least some college"</span>), <span class="fu">c</span>(<span class="st">"High school or less"</span>, <span class="st">"At least some college"</span>))) </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>marriage<span class="sc">$</span>Freq <span class="ot">&lt;-</span> <span class="fu">c</span>(  <span class="dv">6</span>,<span class="dv">2</span>,<span class="dv">10</span>,<span class="dv">8</span>,<span class="dv">3</span>,<span class="dv">9</span>,<span class="dv">11</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">11</span>,<span class="dv">21</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">22</span>,<span class="dv">4</span>,<span class="dv">1</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>marriage_tab <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(<span class="at">data =</span> marriage, Freq <span class="sc">~</span> educ <span class="sc">+</span> relig <span class="sc">+</span> opinion)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ftable</span>(marriage_tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                     opinion Agree Neutral Disagree
educ                  relig                                        
High school or less   Liberal                   11       5        6
                      Moderate                   8       3        9
                      Fundamentalist             6       2       10
At least some college Liberal                   22       4        1
                      Moderate                  21       3        5
                      Fundamentalist             4       2       11</code></pre>
</div>
</div>
<p>If we just think about questions regarding whether and how these three variables are related, we can fit a log linear model, with the count frequencies as the responses, and the levels of three factors as explanatory information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mod_relig <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">data =</span> marriage_tab, Freq <span class="sc">~</span> relig <span class="sc">+</span> educ <span class="sc">+</span> opinion, <span class="at">family =</span> poisson)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_relig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Freq ~ relig + educ + opinion, family = poisson, 
    data = marriage_tab)

Coefficients:
                            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                2.482e+00  1.895e-01  13.095  &lt; 2e-16 ***
religModerate             -5.009e-15  2.020e-01   0.000   1.0000    
religFundamentalist       -3.365e-01  2.213e-01  -1.520   0.1284    
educAt least some college  1.961e-01  1.743e-01   1.125   0.2604    
opinionNeutral            -1.332e+00  2.579e-01  -5.165  2.4e-07 ***
opinionDisagree           -5.390e-01  1.942e-01  -2.776   0.0055 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 72.362  on 17  degrees of freedom
Residual deviance: 34.930  on 12  degrees of freedom
AIC: 111.43

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>The results of this model seem to indicate that the only factor that is associated with variation in the table frequencies is the opinion regarding gay marriage. What about the association questions?</p>
</section>
<section id="lab-5-assignment" class="level1">
<h1>Lab 5 Assignment</h1>
<section id="questions" class="level2">
<h2 class="anchored" data-anchor-id="questions">Questions</h2>
<ol type="1">
<li><p>Fit a model to the gay marriage data that includes all two-way interactions. What do you conclude from this model? Be specific and try to address questions having to do with the association among the three variables.</p></li>
<li><p>Fit a model that includes all two-way and the three-way interactions. Is there anything problematic about this model? Please explain.</p></li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>